--------------------------------------------------------
--  DDL for Procedure TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" 
AS

BEGIN

   EXECUTE IMMEDIATE ' TRUNCATE TABLE RBL_STGDB.ExceptionFinalStatusType_AllData ';
   INSERT INTO RBL_STGDB.ExceptionFinalStatusType_AllData
     ( DateOfData, HostSystem, CustomerACID, CustomerID, UCIC, Flag, Amount, StatusDate, StatusType )
     ( SELECT * 
       FROM ( SELECT TO_DATE(ReportData,'YYYY-MM-DD') date_  ,
                     'Finacle' HostSystem  ,
                     CustomerACID ,
                     CustomerID ,
                     NULL UCIC  ,
                     NULL Flag  ,
                     SUM(WRITEOFFAMOUNT)  AMOUNT  ,
                     MIN(UTILS.CONVERT_TO_VARCHAR2(WRITEOFFDATE,200))  StatusDate  ,
                     'WO' StatusType  
              FROM DWH_RBL_MISDB_PROD.WriteOffData_SCF 
                GROUP BY CustomerACID,TO_DATE(ReportData,'YYYY-MM-DD'),HostSystem,CustomerID
              UNION ALL 
              SELECT TO_DATE(ReportData,'YYYY-MM-DD') Date_  ,
                     HostSystem ,
                     CustomerACID ,
                     CustomerID ,
                     UCIC ,
                     WriteOffFlag ,
                     WriteOffAmount AMOUNT  ,
                     UTILS.CONVERT_TO_VARCHAR2(WRITEOFFDATE,200) StatusDate  ,
                     'WO' StatusType  
              FROM DWH_RBL_MISDB_PROD.WriteOffData 
              UNION ALL 
              SELECT TO_DATE(dateofdata,'YYYY-MM-DD') DATE_  ,
                     Sourcesystem ,
                     CustomerAcID ,
                     CustomerID ,
                     UCIC_ID ,
                     Settlement_Flag ,
                     0 Amount  ,
                     UTILS.CONVERT_TO_VARCHAR2(Settlement_Date,200) StatusDate  ,
                     'Settlement' StatusType  
              FROM RBL_STGDB.ACCOUNT_ALL_SOURCE_SYSTEM 
               WHERE  ( Settlement_Date IS NOT NULL
                        OR Settlement_Flag = 'Y' )
              UNION ALL 
              SELECT Date_of_Data ,
                     'SCF' HostSystem  ,
                     RefSystemAcid ,
                     NULL RefSystemAcid_CIF_ID  ,
                     NULL RefSystemAcid_UCIC  ,
                     Settlement_Flag ,
                     0 Amount  ,
                     MIN(UTILS.CONVERT_TO_VARCHAR2(Settlement_Date,200))  StatusDate  ,
                     'Settlement' StatusType  
              FROM DWH_RBL_MISDB_PROD.BILLS_DATA_STG_SCF 
               WHERE  ( Settlement_Date IS NOT NULL
                        OR Settlement_Flag = 'Y' )
                GROUP BY RefSystemAcid,Date_of_Data,Settlement_Flag
              UNION ALL 
              SELECT TO_DATE(Date_of_data,'YYYY-MM-DD') ,
                     'VisionPlus' HostSystem  ,
                     TO_CHAR(Customer_Ac_Id) RefSystemAcid  ,
                     TO_CHAR(Customer_Id) CustomerID  ,
                     TO_CHAR(ucic) ,
                     TO_CHAR(Charge_Off_flag) ,
                     TO_NUMBER(Charge_off_Amount) Amount  ,
                     UTILS.CONVERT_TO_VARCHAR2(Charge_Off_date,200) StatusDate  ,
                     'Charge Off' StatusType  
              FROM RBL_STGDB.account_data_visionplus 
               WHERE  ( Charge_Off_date IS NOT NULL
                        OR Charge_off_flag = 'Y' --AND Balance_Outstanding_INR>0
                       )
              UNION ALL 
              SELECT Date_of_data ,
                     'Finacle' HostSystem  ,
                     Customer_Ac_Id RefSystemAcid  ,
                     Customer_Id CustomerID  ,
                     ucic ,
                     Charge_Off_flag ,
                     NULL Amount  ,
                     TO_CHAR(Charge_Off_date) StatusDate  ,
                     'Charge Off' StatusType  
              FROM DWH_STG.account_data_finacle 
               WHERE  ( Charge_Off_date IS NOT NULL
                        OR Charge_off_flag = 'Y' )
                        AND Balance_Outstanding_INR > 0
              UNION ALL 
              SELECT Date_of_data ,
                     source_system_name ,
                     issuerId RefSystemAcid  ,
                     NULL CustomerID  ,
                     ucic_id ,
                     Settlement_Flag ,
                     NULL Amount  ,
                     UTILS.CONVERT_TO_VARCHAR2(Settlement_Date,200) StatusDate  ,
                     'Settlement' StatusType  
              FROM DWH_RBL_MISDB_PROD.InvestmentIssuerDetail 
               WHERE  ( Settlement_Date IS NOT NULL
                        OR Settlement_Flag = 'Y' ) ) A );
   ETL_TEMP_RBL_TEMPDB.ExceptionFinalStatusType_Temp() ;

EXCEPTION WHEN NO_DATA_FOUND THEN DBMS_OUTPUT.PUT_LINE('NO DATA FOUND');
            WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "MAIN_PRO";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "MAIN_PRO";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "RBL_TEMPDB";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_STGDB"."TRANSFER_EXCEPTIONFINALSTATUSTYPEDATA_ALL_SOURCE_SYSTEM" TO "ADF_CDR_RBL_STGDB";
