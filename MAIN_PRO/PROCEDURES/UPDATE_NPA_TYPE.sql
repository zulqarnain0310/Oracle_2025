--------------------------------------------------------
--  DDL for Procedure UPDATE_NPA_TYPE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "MAIN_PRO"."UPDATE_NPA_TYPE" /*=========================================
 AUTHER : TRILOKI KHANNA
 CREATE DATE : 30-12-2019
 MODIFY DATE : 31-12-2019
 DESCRIPTION :UPDATE NPA TYPE AT ACCOUNT LEVEL
 EXEC [PRO].[UPDATE_NPA_TYPE] 4925
=============================================*/
(
  v_TIMEKEY IN NUMBER
)
AS

BEGIN

   /*----------------Update NpaType in account cal table ---------------------------- */
   --UPDATE A SET NpaType=C.SecuritizationGroup
   --FROM PRO.AccountCal A
   --INNER JOIN CURDAT.AdvAcBasicDetail B
   --ON A.AccountEntityID=B.AccountEntityId
   --INNER JOIN DBO.DimSecuritization C
   --ON B.SecuritizationCode=C.SecuritizationCode
   --INNER JOIN DimAssetClass D ON A.FinalAssetClassAlt_Key=D.AssetClassAlt_Key   AND (D.EffectiveFromTimeKey<=@TIMEKEY AND D.EffectiveToTimeKey>=@TIMEKEY)
   --WHERE (A.EffectiveFromTimeKey<=@TIMEKEY AND A.EffectiveToTimeKey>=@TIMEKEY)
   --AND (B.EffectiveFromTimeKey<=@TIMEKEY AND B.EffectiveToTimeKey>=@TIMEKEY)
   --AND (C.EffectiveFromTimeKey<=@TIMEKEY AND C.EffectiveToTimeKey>=@TIMEKEY)
   ----AND D.AssetClassGroup='NPA'
   /*----------------Update NpaType in account cal table ---------------------------- */
   MERGE INTO GTT_AccountCal A
   USING (SELECT A.ROWID row_id, (CASE 
   WHEN CD = 5
     AND DA.ASSETCLASSSHORTNAME = 'SUB'
     AND DPD_MAX BETWEEN 90 AND 119 THEN 'REGULAR'
   WHEN CD = 6
     AND DA.ASSETCLASSSHORTNAME = 'SUB'
     AND DPD_MAX BETWEEN 120 AND 149 THEN 'REGULAR'
   WHEN CD = 7
     AND DA.ASSETCLASSSHORTNAME = 'SUB'
     AND DPD_MAX BETWEEN 150 AND 179 THEN 'REGULAR'
   WHEN CD = 8
     AND DA.ASSETCLASSSHORTNAME = 'SUB'
     AND DPD_MAX BETWEEN 180 AND 209 THEN 'REGULAR'
   WHEN CD = 9
     AND DA.ASSETCLASSSHORTNAME = 'SUB'
     AND DPD_MAX >= 210 THEN 'REGULAR'
   WHEN CD = 5
     AND DA.ASSETCLASSSHORTNAME = 'DB1'
     AND DPD_MAX BETWEEN 90 AND 119 THEN 'REGULAR'
   WHEN CD = 6
     AND DA.ASSETCLASSSHORTNAME = 'DB1'
     AND DPD_MAX BETWEEN 120 AND 149 THEN 'REGULAR'
   WHEN CD = 7
     AND DA.ASSETCLASSSHORTNAME = 'DB1'
     AND DPD_MAX BETWEEN 150 AND 179 THEN 'REGULAR'
   WHEN CD = 8
     AND DA.ASSETCLASSSHORTNAME = 'DB1'
     AND DPD_MAX BETWEEN 180 AND 209 THEN 'REGULAR'
   WHEN CD = 9
     AND DA.ASSETCLASSSHORTNAME = 'DB1'
     AND DPD_MAX >= 210 THEN 'REGULAR'
   WHEN CD = 5
     AND DA.ASSETCLASSSHORTNAME = 'DB2'
     AND DPD_MAX BETWEEN 90 AND 119 THEN 'REGULAR'
   WHEN CD = 6
     AND DA.ASSETCLASSSHORTNAME = 'DB2'
     AND DPD_MAX BETWEEN 120 AND 149 THEN 'REGULAR'
   WHEN CD = 7
     AND DA.ASSETCLASSSHORTNAME = 'DB2'
     AND DPD_MAX BETWEEN 150 AND 179 THEN 'REGULAR'
   WHEN CD = 8
     AND DA.ASSETCLASSSHORTNAME = 'DB2'
     AND DPD_MAX BETWEEN 180 AND 209 THEN 'REGULAR'
   WHEN CD = 9
     AND DA.ASSETCLASSSHORTNAME = 'DB2'
     AND DPD_MAX >= 210 THEN 'REGULAR'
   WHEN CD = 5
     AND DA.ASSETCLASSSHORTNAME = 'DB3'
     AND DPD_MAX BETWEEN 90 AND 119 THEN 'REGULAR'
   WHEN CD = 6
     AND DA.ASSETCLASSSHORTNAME = 'DB3'
     AND DPD_MAX BETWEEN 120 AND 149 THEN 'REGULAR'
   WHEN CD = 7
     AND DA.ASSETCLASSSHORTNAME = 'DB3'
     AND DPD_MAX BETWEEN 150 AND 179 THEN 'REGULAR'
   WHEN CD = 8
     AND DA.ASSETCLASSSHORTNAME = 'DB3'
     AND DPD_MAX BETWEEN 180 AND 209 THEN 'REGULAR'
   WHEN CD = 9
     AND DA.ASSETCLASSSHORTNAME = 'DB3'
     AND DPD_MAX >= 210 THEN 'REGULAR'
   WHEN CD = 2
     AND DA.ASSETCLASSSHORTNAME = 'SUB'
     AND DPD_MAX BETWEEN 1 AND 29 THEN 'STICKY'
   WHEN CD = 3
     AND DA.ASSETCLASSSHORTNAME = 'SUB'
     AND DPD_MAX BETWEEN 30 AND 59 THEN 'STICKY'
   WHEN CD = 4
     AND DA.ASSETCLASSSHORTNAME = 'SUB'
     AND DPD_MAX BETWEEN 60 AND 89 THEN 'STICKY'
   WHEN CD = 2
     AND DA.ASSETCLASSSHORTNAME = 'DB1'
     AND DPD_MAX BETWEEN 1 AND 29 THEN 'STICKY'
   WHEN CD = 3
     AND DA.ASSETCLASSSHORTNAME = 'DB1'
     AND DPD_MAX BETWEEN 30 AND 59 THEN 'STICKY'
   WHEN CD = 4
     AND DA.ASSETCLASSSHORTNAME = 'DB1'
     AND DPD_MAX BETWEEN 60 AND 89 THEN 'STICKY'
   WHEN CD = 2
     AND DA.ASSETCLASSSHORTNAME = 'DB2'
     AND DPD_MAX BETWEEN 1 AND 29 THEN 'STICKY'
   WHEN CD = 3
     AND DA.ASSETCLASSSHORTNAME = 'DB2'
     AND DPD_MAX BETWEEN 30 AND 59 THEN 'STICKY'
   WHEN CD = 4
     AND DA.ASSETCLASSSHORTNAME = 'DB2'
     AND DPD_MAX BETWEEN 60 AND 89 THEN 'STICKY'
   WHEN CD = 2
     AND DA.ASSETCLASSSHORTNAME = 'DB3'
     AND DPD_MAX BETWEEN 1 AND 29 THEN 'STICKY'
   WHEN CD = 3
     AND DA.ASSETCLASSSHORTNAME = 'DB3'
     AND DPD_MAX BETWEEN 30 AND 59 THEN 'STICKY'
   WHEN CD = 4
     AND DA.ASSETCLASSSHORTNAME = 'DB3'
     AND DPD_MAX BETWEEN 60 AND 89 THEN 'STICKY'
   WHEN CD = 0
     AND DA.ASSETCLASSSHORTNAME = 'SUB'
     AND DPD_MAX = 0 THEN 'MULTIPLE'
   WHEN CD = 1
     AND DA.ASSETCLASSSHORTNAME = 'SUB'
     AND DPD_MAX = 0 THEN 'MULTIPLE'
   WHEN CD = 2
     AND DA.ASSETCLASSSHORTNAME = 'SUB'
     AND DPD_MAX BETWEEN 1 AND 29 THEN 'MULTIPLE'
   WHEN CD = 3
     AND DA.ASSETCLASSSHORTNAME = 'SUB'
     AND DPD_MAX BETWEEN 30 AND 59 THEN 'MULTIPLE'
   WHEN CD = 4
     AND DA.ASSETCLASSSHORTNAME = 'SUB'
     AND DPD_MAX BETWEEN 60 AND 89 THEN 'MULTIPLE'
   WHEN CD = 0
     AND DA.ASSETCLASSSHORTNAME = 'DB1'
     AND DPD_MAX = 0 THEN 'MULTIPLE'
   WHEN CD = 1
     AND DA.ASSETCLASSSHORTNAME = 'DB1'
     AND DPD_MAX = 0 THEN 'MULTIPLE'
   WHEN CD = 2
     AND DA.ASSETCLASSSHORTNAME = 'DB1'
     AND DPD_MAX BETWEEN 1 AND 29 THEN 'MULTIPLE'
   WHEN CD = 3
     AND DA.ASSETCLASSSHORTNAME = 'DB1'
     AND DPD_MAX BETWEEN 30 AND 59 THEN 'MULTIPLE'
   WHEN CD = 4
     AND DA.ASSETCLASSSHORTNAME = 'DB1'
     AND DPD_MAX BETWEEN 60 AND 89 THEN 'MULTIPLE'
   WHEN CD = 0
     AND DA.ASSETCLASSSHORTNAME = 'DB2'
     AND DPD_MAX = 0 THEN 'MULTIPLE'
   WHEN CD = 1
     AND DA.ASSETCLASSSHORTNAME = 'DB2'
     AND DPD_MAX = 0 THEN 'MULTIPLE'
   WHEN CD = 2
     AND DA.ASSETCLASSSHORTNAME = 'DB2'
     AND DPD_MAX BETWEEN 1 AND 29 THEN 'MULTIPLE'
   WHEN CD = 3
     AND DA.ASSETCLASSSHORTNAME = 'DB2'
     AND DPD_MAX BETWEEN 30 AND 59 THEN 'MULTIPLE'
   WHEN CD = 4
     AND DA.ASSETCLASSSHORTNAME = 'DB2'
     AND DPD_MAX BETWEEN 60 AND 89 THEN 'MULTIPLE'
   WHEN CD = 0
     AND DA.ASSETCLASSSHORTNAME = 'DB3'
     AND DPD_MAX = 0 THEN 'MULTIPLE'
   WHEN CD = 1
     AND DA.ASSETCLASSSHORTNAME = 'DB3'
     AND DPD_MAX = 0 THEN 'MULTIPLE'
   WHEN CD = 2
     AND DA.ASSETCLASSSHORTNAME = 'DB3'
     AND DPD_MAX BETWEEN 1 AND 29 THEN 'MULTIPLE'
   WHEN CD = 3
     AND DA.ASSETCLASSSHORTNAME = 'DB3'
     AND DPD_MAX BETWEEN 30 AND 59 THEN 'MULTIPLE'
   WHEN CD = 4
     AND DA.ASSETCLASSSHORTNAME = 'DB3'
     AND DPD_MAX BETWEEN 60 AND 89 THEN 'MULTIPLE'   END) AS NpaType
   FROM GTT_AccountCal A
          JOIN RBL_MISDB_PROD.DimSourceDB B   ON A.SourceAlt_Key = B.SourceAlt_Key
          AND ( B.EffectiveFromTimeKey <= v_TIMEKEY
          AND B.EffectiveToTimeKey >= v_TIMEKEY )
          JOIN RBL_MISDB_PROD.DimAssetClass DA   ON A.FinalAssetClassAlt_Key = DA.AssetClassAlt_Key
          AND ( DA.EffectiveFromTimeKey <= v_TIMEKEY
          AND DA.EffectiveToTimeKey >= v_TIMEKEY ) 
    WHERE B.SourceName = 'VisionPLUS'
     AND DA.AssetClassGroup = 'NPA') src
   ON ( A.ROWID = src.row_id )
   WHEN MATCHED THEN UPDATE SET A.NpaType = src.NpaType;

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "RBL_TEMPDB";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."UPDATE_NPA_TYPE" TO "ADF_CDR_RBL_STGDB";
