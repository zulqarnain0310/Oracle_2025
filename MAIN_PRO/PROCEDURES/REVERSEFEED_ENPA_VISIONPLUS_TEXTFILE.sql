--------------------------------------------------------
--  DDL for Procedure REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" /*=========================================
AUTHER : TRILOKI KHANNA
CREATE DATE : 22-04-2021
MODIFY DATE : 22-04-2021
DESCRIPTION : PRO.REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE
--EXEC [PRO].[REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE] '2020-09-30'
============================================*/
(
  --DECLARE
  v_FileDate IN VARCHAR2 DEFAULT '2021-04-22' 
)
AS
   -- CAST(@FileDate AS DATE) --EFFECTIVEFROMTIMEKEY=@TIMEKEY AND EFFECTIVETOTIMEKEY=@TIMEKEY
   v_cursor SYS_REFCURSOR;

BEGIN

   --DECLARE @TIMEKEY INT = (SELECT TIMEKEY FROM PRO.EXTDATE_MISDB WHERE FLG = 'Y')
   --DECLARE @Date DATE =(SELECT CAST(EndDate AS DATE) FROM PRO.EXTDATE_MISDB WHERE Flg='Y')
   OPEN  v_cursor FOR
      SELECT LPAD('',3 - LENGTH(ATHEZ_H_ORG),'0') || UTILS.CONVERT_TO_VARCHAR2(ATHEZ_H_ORG,30) || LPAD('',8 - LENGTH(ATHEZ_H_CLIENT_ID),'0') || UTILS.CONVERT_TO_VARCHAR2(ATHEZ_H_CLIENT_ID,30) || LPAD('',8 - LENGTH(ATHEZ_H_DATE),'0') || UTILS.CONVERT_TO_VARCHAR2(ATHEZ_H_DATE,30) || LPAD('',1 - LENGTH(ATHEZ_H_BULK_UPD_ONLINE),' ') || UTILS.CONVERT_TO_VARCHAR2(ATHEZ_H_BULK_UPD_ONLINE,30) || NVL(RTRIM(LTRIM(UTILS.CONVERT_TO_NVARCHAR2(FILLER,30))), ' ') || LPAD('',180 - LENGTH(NVL(RTRIM(LTRIM(UTILS.CONVERT_TO_NVARCHAR2(FILLER,30))), ' ')),' ') FileDataLines  ,
             'FileData' TableName  
        FROM RBL_MISDB_PROD.REVERSEFEED_ENPA_HEADER 
       WHERE  DateofData = v_FileDate
      UNION ALL 
      SELECT LPAD('',3 - LENGTH(RTRIM(LTRIM(ATHEZ_D_ORG))),'0') || UTILS.CONVERT_TO_VARCHAR2(RTRIM(LTRIM(ATHEZ_D_ORG)),30) || LPAD('',19 - LENGTH(RTRIM(LTRIM(ATHEZ_D_ACCT_NBR))),'0') || UTILS.CONVERT_TO_VARCHAR2(RTRIM(LTRIM(ATHEZ_D_ACCT_NBR)),30) || LPAD('',4 - LENGTH(RTRIM(LTRIM(ATHEZ_D_CARD_SEQ_NBR))),'0') || UTILS.CONVERT_TO_VARCHAR2(RTRIM(LTRIM(ATHEZ_D_CARD_SEQ_NBR)),30) || LPAD('',2 - LENGTH(RTRIM(LTRIM(ATHEZ_D_FILE_CODE))),'0') || UTILS.CONVERT_TO_VARCHAR2(RTRIM(LTRIM(ATHEZ_D_FILE_CODE)),30) || LPAD('',4 - LENGTH(RTRIM(LTRIM(ATHEZ_D_FIELD_CODE))),'0') || UTILS.CONVERT_TO_VARCHAR2(RTRIM(LTRIM(ATHEZ_D_FIELD_CODE)),30) || LPAD('',4 - LENGTH(RTRIM(LTRIM(ATHEZ_D_FIELD_OCCURRENCE))),'0') || UTILS.CONVERT_TO_VARCHAR2(RTRIM(LTRIM(ATHEZ_D_FIELD_OCCURRENCE)),30) || LPAD('',3 - LENGTH(RTRIM(LTRIM(ATHEZ_D_FIELD_LENGTH))),'0') || UTILS.CONVERT_TO_VARCHAR2(RTRIM(LTRIM(ATHEZ_D_FIELD_LENGTH)),30) || UTILS.CONVERT_TO_VARCHAR2(RTRIM(LTRIM(ATHEZ_D_BEFORE_DATA)),30) || LPAD('',60 - LENGTH(RTRIM(LTRIM(ATHEZ_D_BEFORE_DATA))),' ') || UTILS.CONVERT_TO_VARCHAR2(RTRIM(LTRIM(ATHEZ_D_AFTER_DATA)),30) || LPAD('',60 - LENGTH(RTRIM(LTRIM(ATHEZ_D_AFTER_DATA))),' ') || NVL(RTRIM(LTRIM(UTILS.CONVERT_TO_NVARCHAR2(ATHEZ_D_SIGNON,30))), ' ') || LPAD('',20 - LENGTH(NVL(RTRIM(LTRIM(UTILS.CONVERT_TO_NVARCHAR2(ATHEZ_D_SIGNON,30))), ' ')),' ') || NVL(RTRIM(LTRIM(UTILS.CONVERT_TO_NVARCHAR2(FILLER,30))), ' ') || LPAD('',11 - LENGTH(NVL(RTRIM(LTRIM(UTILS.CONVERT_TO_NVARCHAR2(FILLER,30))), ' ')),' ') || NVL(RTRIM(LTRIM(UTILS.CONVERT_TO_NVARCHAR2(ATHEZ_D_PLAN_NBR,30))), ' ') || LPAD('',5 - LENGTH(NVL(RTRIM(LTRIM(UTILS.CONVERT_TO_NVARCHAR2(ATHEZ_D_PLAN_NBR,30))), ' ')),' ') || NVL(RTRIM(LTRIM(UTILS.CONVERT_TO_NVARCHAR2(ATHEZ_D_REC_NBR,30))), ' ') || LPAD('',3 - LENGTH(NVL(RTRIM(LTRIM(UTILS.CONVERT_TO_NVARCHAR2(ATHEZ_D_REC_NBR,30))), ' ')),' ') || NVL(RTRIM(LTRIM(UTILS.CONVERT_TO_NVARCHAR2(ATHEZ_D_REC_TYPE_KEY,30))), ' ') || LPAD('',2 - LENGTH(NVL(RTRIM(LTRIM(UTILS.CONVERT_TO_NVARCHAR2(ATHEZ_D_REC_TYPE_KEY,30))), ' ')),' ') FileDataLines  ,
             'FileData' TableName  
        FROM RBL_MISDB_PROD.REVERSEFEED_ENPA_DETAIL 
       WHERE  DateofData = v_FileDate
      UNION 
      -- EFFECTIVEFROMTIMEKEY=@TIMEKEY AND EFFECTIVETOTIMEKEY=@TIMEKEY
      ALL 
      SELECT LPAD('',3 - LENGTH(ATHEZ_T_REC_TYPE),'0') || UTILS.CONVERT_TO_VARCHAR2(ATHEZ_T_REC_TYPE,30) || LPAD('',9 - LENGTH(ATHEZ_T_TRANS_TOTAL),'0') || UTILS.CONVERT_TO_VARCHAR2(ATHEZ_T_TRANS_TOTAL,30) || NVL(RTRIM(LTRIM(UTILS.CONVERT_TO_NVARCHAR2(FILLER,30))), ' ') || LPAD('',188 - LENGTH(NVL(RTRIM(LTRIM(UTILS.CONVERT_TO_NVARCHAR2(FILLER,30))), ' ')),' ') FileDataLines  ,
             'FileData' TableName  
        FROM RBL_MISDB_PROD.ReverseFeed_ENPA_Trailer 
       WHERE  DateofData = v_FileDate ;
      DBMS_SQL.RETURN_RESULT(v_cursor);--EFFECTIVEFROMTIMEKEY=@TIMEKEY AND EFFECTIVETOTIMEKEY=@TIMEKEY
   --order by [ATHEZ-D-ACCT-NBR]

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "RBL_TEMPDB";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."REVERSEFEED_ENPA_VISIONPLUS_TEXTFILE" TO "ADF_CDR_RBL_STGDB";
