--------------------------------------------------------
--  DDL for Procedure PROCESSINGSTEPS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "MAIN_PRO"."PROCESSINGSTEPS" 
AS
   v_cursor SYS_REFCURSOR;
   v_TimeKey NUMBER(10,0);
   v_ProcessingDateAudit VARCHAR2(200);

BEGIN

  SELECT Date_ INTO v_ProcessingDateAudit
     FROM RBL_MISDB_PROD.Automate_Advances 
    WHERE  EXT_FLG = 'Y' ;
   --UPDATE PRO.EXTDATE_MISDB SET LAST_EXTDATE = (SELECT MAX(PROCESSINGDATE)  FROM PRO.PACKAGE_AUDITHIST) WHERE Flg='Y'--Extration date
   --UPDATE PRO.EXTDATE_MISDB SET Flg='U' WHERE   Flg='Y'
   --UPDATE DBO.RBL_MISDB_PROD.SysDataMatrix SET CurrentStatus='U' WHERE   CurrentStatus='C'
   --DECLARE  @vEffectivefrom  Int SET @vEffectiveFrom=(SELECT TimeKey FROM [dbo].Automate_Advances WHERE EXT_FLG='Y')
   --DECLARE @TimeKey  Int SET @TimeKey=(SELECT TimeKey FROM [dbo].Automate_Advances WHERE EXT_FLG='Y')
   --DECLARE @DATE AS DATE =(SELECT Date FROM [dbo].Automate_Advances WHERE EXT_FLG='Y')
   UPDATE RBL_MISDB_PROD.Automate_Advances
      SET EXT_FLG = 'U'
    WHERE  EXT_FLG = 'Y';
   UPDATE RBL_MISDB_PROD.SysDataMatrix
      SET CurrentStatus = 'U'
    WHERE  CurrentStatus = 'C';
   UPDATE RBL_MISDB_PROD.Automate_Advances
      SET EXT_FLG = 'Y'
    WHERE  TimeKey IN ( SELECT MAX(Package_AuditHist.TimeKey)  + 1 
                        FROM MAIN_PRO.Package_AuditHist 
                         WHERE  Package_AuditHist.IdentityKey = 5 )
   ;
   UPDATE RBL_MISDB_PROD.SysDataMatrix
      SET CurrentStatus = 'C'
    WHERE  TimeKey IN ( SELECT MAX(Package_AuditHist.TimeKey)  + 1 
                        FROM MAIN_PRO.Package_AuditHist 
                         WHERE  Package_AuditHist.IdentityKey = 5 )
   ;
   /*OPEN  v_cursor FOR
      SELECT 'Checksum' TableName  ,
             COUNT(TABLE_NAME)  COUNT  ,
             UTILS.CONVERT_TO_VARCHAR2(ETL_DATE,200) ETL_DATE  
        FROM RBL_MISDB_PROD.EXTRACTION_STATUS 
       WHERE  ETL_DATE IN ( SELECT Date_ 
                            FROM RBL_MISDB_PROD.Automate_Advances 
                             WHERE  EXT_FLG = 'Y' --*******UNCOMMENT THIS LINE***********
               )

        GROUP BY ETL_DATE

         HAVING COUNT(TABLE_NAME)  = 2 ;
      DBMS_SQL.RETURN_RESULT(v_cursor);--***********TO BE SET TO 2***********
   OPEN  v_cursor FOR
      SELECT 'ExtractionStatus' TableName  ,
             Table_Name LoadedTables  ,
             ETL_Date ETLDate  
        FROM RBL_MISDB_PROD.EXTRACTION_STATUS  ;
      DBMS_SQL.RETURN_RESULT(v_cursor);--***********LINE TO BE ADDED***********
      */
   OPEN  v_cursor FOR
      SELECT PARAMETERNAME TableName  ,
             ParameterValue TimePeriod  
        FROM RBL_MISDB_PROD.SYSSOLUTIONPARAMETER 
       WHERE  PARAMETERNAME = 'REFRESHPERIOD' ;
      DBMS_SQL.RETURN_RESULT(v_cursor);
   OPEN  v_cursor FOR
      SELECT 'ProcessingStatus' TableName  
        FROM MAIN_PRO.Package_AUDIT 
       WHERE  IDENTITYKEY = '5'
                AND EXECUTIONSTATUS = 'Y'
                AND ProcessingDate = ( SELECT Date_ 
                                       FROM RBL_MISDB_PROD.Automate_Advances 
                                        WHERE  EXT_FLG = 'Y' ) ;
      DBMS_SQL.RETURN_RESULT(v_cursor);--***********LINE TO BE ADDED***********
   DELETE MAIN_PRO.Package_AUDIT

    WHERE  ProcessingDate IN ( SELECT MAX(ProcessingDate)  
                               FROM MAIN_PRO.Package_AuditHist 
                                WHERE  IdentityKey = 5 )
   ;--***********LINE TO BE ADDED***********
   SELECT TimeKey 

     INTO v_TimeKey
     FROM RBL_MISDB_PROD.Automate_Advances 
    WHERE  EXT_FLG = 'Y';
   OPEN  v_cursor FOR
      SELECT 'ProcessingDate' TableName  ,
             MonthLastDate PROCESSINGDATE  
        FROM RBL_MISDB_PROD.SysDataMatrix 
       WHERE  CURRENTSTATUS = 'C' --***********LINE TO BE MODIFIED***********
    ;
      DBMS_SQL.RETURN_RESULT(v_cursor);

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."PROCESSINGSTEPS" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "RBL_TEMPDB";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."PROCESSINGSTEPS" TO "ADF_CDR_RBL_STGDB";
