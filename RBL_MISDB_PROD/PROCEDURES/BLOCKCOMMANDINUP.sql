--------------------------------------------------------
--  DDL for Procedure BLOCKCOMMANDINUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" /* CREATED BY DF627 on 23-05-24 FOR STORING THE RECORDS OF CURRENTLY EXECUTING QUERIES WITHIN THE SQL SERVER INSTANCE   */
AS

BEGIN

   INSERT INTO RBL_MISDB_PROD.SpBlock
     SELECT --r.start_time Start_Time  ,
            A.SID SPID  ,
            SYS_CONTEXT('USERENV','') Database  ,
            t.TEXT QueryName ,--ADDED ON 18-07-2023

            SUBSTR(t.TEXT, (r.statement_start_offset / 2) + 1, CASE 
                                                                    WHEN statement_end_offset = -1
                                                                      OR statement_end_offset = 0 THEN (LENGTHB(t.TEXT) - r.statement_start_offset / 2) + 1
                   ELSE (r.statement_end_offset - r.statement_start_offset) / 2 + 1
                      END) Executing_SQL  ,
            A.STATUS ,
            command ,
            wait_type ,
            wait_time ,
            wait_resource ,
            last_wait_type ,
            A.program_name ,--ADDED ON 18-07-2023

            A.login_name ,--ADDED ON 18-07-2023

            A 
            .HOST_NAME ,--ADDED ON 18-07-2023

            --,A.last_request_start_time --ADDED ON 18-07-2023
            CASE 
                 WHEN t.TEXT LIKE '%create proc%' THEN REPLACE(REPLACE(REPLACE(REPLACE(SUBSTR(t.TEXT, INSTR(t.TEXT, 'create proc'), INSTR(t.TEXT, 'as')), 'create procedure', ' '), 'declare', ' '), '@', ' '), 'create proc', ' ')   END SpName  
       FROM sys.dm_exec_requests r
               OUTER APPLY sys.dm_exec_sql_text(sql_handle) t 
              LEFT JOIN V$SESSION A ON A.session_id = R.session_id --ADDED ON 18-07-2023
      WHERE  r.session_id -- don't show this query
              != USERENV('sessionid')
               AND r.session_id > 50 -- don't show system queries

               AND t.TEXT IS NOT NULL --ADDED ON 18-07-2023

       ORDER BY r.start_time;

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "MAIN_PRO";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "MAIN_PRO";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."BLOCKCOMMANDINUP" TO "ADF_CDR_RBL_STGDB";
