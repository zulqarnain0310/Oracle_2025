--------------------------------------------------------
--  DDL for Procedure REBUILDINDEX_MANDEEP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" 
AS
   --SELECT * FROM tt_NEWTEMP
   v_MAX NUMBER(10,0);
   v_MIN NUMBER(10,0);
   v_CONTENT NVARCHAR2(2000);
   v_INDEX NVARCHAR2(2000);
   v_TABLE NVARCHAR2(2000);
   v_cursor SYS_REFCURSOR;

BEGIN

   TABLE IF  --SQLDEV: NOT RECOGNIZED
   IF tt_temp_224  --SQLDEV: NOT RECOGNIZED
   DELETE FROM tt_temp_224;
   UTILS.IDENTITY_RESET('tt_temp_224');

   INSERT INTO tt_temp_224 ( 
   	SELECT * 
   	  FROM sys.tables 
   	 WHERE  /*TODO:SQLDEV*/ OBJECTPROPERTY(object_id,'Isindexed') /*END:SQLDEV*/ = 1 );
   IF  --SQLDEV: NOT RECOGNIZED
   IF tt_NEWTEMP  --SQLDEV: NOT RECOGNIZED
   DELETE FROM tt_NEWTEMP;
   UTILS.IDENTITY_RESET('tt_NEWTEMP');

   INSERT INTO tt_NEWTEMP SELECT A.OBJECT_ID ,
                                 b.* ,
                                 ROW_NUMBER() OVER ( PARTITION BY B.TABLE_CATALOG ORDER BY B.TABLE_CATALOG  ) SNO  
        FROM tt_temp_224 A
               JOIN INFORMATION_SCHEMA.TABLES b   ON b.TABLE_NAME = A.NAME
       WHERE  b.TABLE_SCHEMA NOT IN ( 'dbo','PreMoc' )
   ;
   SELECT MAX(SNO)  

     INTO v_MAX
     FROM tt_NEWTEMP ;
   v_MIN := 11 ;
   WHILE v_MIN <= v_MAX 
   LOOP 

      BEGIN
         SELECT TABLE_SCHEMA || '.' || TABLE_NAME 

           INTO v_TABLE
           FROM tt_NEWTEMP 
          WHERE  SNO = v_MIN;
         --SELECT @TABLE
         SELECT NAME 

           INTO v_INDEX
           FROM sys.indexes_ 
          WHERE  OBJECT_ID = ( SELECT OBJECT_ID 
                               FROM tt_NEWTEMP 
                                WHERE  SNO = v_MIN )
                   AND TYPE IN ( 1,2 )

           FETCH FIRST 1 ROWS ONLY;
         --SELECT @INDEX
         v_CONTENT := 'ALTER INDEX ' || v_INDEX || ' ON ' || v_TABLE || ' REBUILD ' ;
         OPEN  v_cursor FOR
            SELECT v_CONTENT 
              FROM DUAL  ;
            DBMS_SQL.RETURN_RESULT(v_cursor);
         --SP_UPDATESTATS
         --EXEC sp_executesql @CONTENT
         INSERT INTO RebuildIndex
           ( CONTENT )
           ( SELECT v_CONTENT 
               FROM DUAL  );
         v_MIN := v_MIN + 1 ;

      END;
   END LOOP;

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "MAIN_PRO";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "MAIN_PRO";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."REBUILDINDEX_MANDEEP" TO "ADF_CDR_RBL_STGDB";
