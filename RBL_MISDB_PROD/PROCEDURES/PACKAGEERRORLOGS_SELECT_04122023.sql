--------------------------------------------------------
--  DDL for Procedure PACKAGEERRORLOGS_SELECT_04122023
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" 
(
  v_StartDate IN VARCHAR2 DEFAULT ' ' ,
  v_EndDate IN VARCHAR2 DEFAULT ' ' 
)
AS
   v_cursor SYS_REFCURSOR;
-- EXEC PackageErrorLogs_Select @StartDate=N'01/09/2022',@EndDate=N'15/03/2023'

BEGIN

   /*TODO:SQLDEV*/ SET DATEFORMAT DMY /*END:SQLDEV*/
   ----IF OBJECT_ID('TEMPDB..#JobStartTimeTemp') IS NOT NULL
   ----		DROP TABLE #JobStartTimeTemp
   ------WITH JobTime_CTE AS
   ------(
   ----SELECT A.name AS JobName,C.start_execution_date AS JobStartTime,ROW_NUMBER() OVER (PARTITION BY A.Name ORDER BY C.start_execution_date DESC) RN
   ----INTO #JobStartTimeTemp
   ----from MSDB.DBO.sysjobs A
   ----left join	   msdb.dbo.sysjobhistory B
   ----ON             A.job_id=B.job_id
   ----left join	   msdb.dbo.sysjobactivity C
   ----ON             A.job_id=C.job_id
   ----WHERE			A.name IN('ETLDataExtraction','DWH_Backup','DWH_Backup_Test')
   ------)
   ------SELECt JobName,JobStartTime FROM JobTime_CTE WHERE RN=1
   OPEN  v_cursor FOR
      SELECT ID ,
             MachineName ,
             A.JobName ,
             A.StepName JobStepName  ,
             PackageName ,
             TaskName ,
             ErrorCode ,
             ErrorDescription ,
             CASE 
                  WHEN UTILS.CONVERT_TO_VARCHAR2(JobStartTime,10,p_style=>103) IS NULL THEN ' '
             ELSE (UTILS.CONVERT_TO_VARCHAR2(JobStartTime,30,p_style=>103) || ' ' || UTILS.CONVERT_TO_VARCHAR2(JobStartTime,30,p_style=>108))
                END JobStartTime  ,
             CASE 
                  WHEN UTILS.CONVERT_TO_VARCHAR2(Date_,10,p_style=>103) IS NULL THEN ' '
             ELSE (UTILS.CONVERT_TO_VARCHAR2(Date_,30,p_style=>103) || ' ' || UTILS.CONVERT_TO_VARCHAR2(Date_,30,p_style=>108))
                END PackageErrorDate  ,
             CASE 
                  WHEN UTILS.CONVERT_TO_VARCHAR2(ReportingDate,10,p_style=>103) IS NULL THEN ' '
             ELSE UTILS.CONVERT_TO_VARCHAR2(ReportingDate,10,p_style=>103)
                END ReportingDate  ,
             CASE 
                  WHEN UTILS.CONVERT_TO_VARCHAR2(ProcessDate,10,p_style=>103) IS NULL THEN ' '
             ELSE UTILS.CONVERT_TO_VARCHAR2(ProcessDate,10,p_style=>103)
                END DateofData  
        FROM RBL_STGDB.PackageErrorLogs A

      --LEFT JOIN #JobStartTimeTemp B

      --ON A.JobName=B.JobName

      --AND RN=1

      --WHERE CONVERT(DATE,DATE,103)>=CONVERT(DATE,@StartDate,103) AND CONVERT(DATE,DATE,103)<=CONVERT(DATE,@EndDate,103)
      WHERE  UTILS.CONVERT_TO_VARCHAR2(ProcessDate,200,p_style=>103) >= UTILS.CONVERT_TO_VARCHAR2(v_StartDate,200,p_style=>103)
               AND UTILS.CONVERT_TO_VARCHAR2(ProcessDate,200,p_style=>103) <= UTILS.CONVERT_TO_VARCHAR2(v_EndDate,200,p_style=>103)
        ORDER BY 1 DESC ;
      DBMS_SQL.RETURN_RESULT(v_cursor);

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "MAIN_PRO";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "MAIN_PRO";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PACKAGEERRORLOGS_SELECT_04122023" TO "ADF_CDR_RBL_STGDB";
