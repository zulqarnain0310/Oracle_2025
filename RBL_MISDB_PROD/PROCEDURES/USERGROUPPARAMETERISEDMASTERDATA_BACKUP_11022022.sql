--------------------------------------------------------
--  DDL for Procedure USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" 
(
  v_timekey IN NUMBER
)
AS
   v_cursor SYS_REFCURSOR;

BEGIN

   DBMS_OUTPUT.PUT_LINE('START');
   UPDATE SysCRisMacMenu
      SET Visible = 1
    WHERE  parentid IN ( 10700 )
   ;
   OPEN  v_cursor FOR
      SELECT CtrlName ,
             FldName ,
             FldCaption ,
             FldDataType ,
             FldLength ,
             ErrorCheck ,
             DataSeq ,
             CriticalErrorType ,
             MsgFlag ,
             MsgDescription ,
             ReportFieldNo ,
             ScreenFieldNo ,
             ViableForSCD2 
        FROM metaUserFieldDetail 
       WHERE  FrmName = 'frmUserGroup' ;
      DBMS_SQL.RETURN_RESULT(v_cursor);
   OPEN  v_cursor FOR
      SELECT EntityKey ,
             MenuTitleId ,
             DataSeq ,
             NVL(MenuId, 0) MenuId  ,
             NVL(ParentId, 0) ParentId  ,
             MenuCaption ,
             ActionName ,
             NVL(BusFld, ' ') BusFld  ,
             UTILS.CONVERT_TO_NUMBER(0,1,0) IsChecked  ,
             ROW_NUMBER() OVER ( ORDER BY MenuTitleID, DataSeq  ) srno  ,
             CASE 
                  WHEN NVL(ParentId, 0) IN ( 9999,0 )
                   THEN 'N'
             ELSE 'Y'
                END IsChild  
        FROM SysCRisMacMenu 
       WHERE  Visible = 1
        ORDER BY MenuTitleID,
                 DataSeq ;
      DBMS_SQL.RETURN_RESULT(v_cursor);
   UPDATE SysCRisMacMenu
      SET Visible = 0
    WHERE  ParentId IN ( 10700 )
   ;
   IF utils.object_id('Tempdb..tt_TempReturnDetails_4') IS NOT NULL THEN
    EXECUTE IMMEDIATE ' TRUNCATE TABLE tt_TempReturnDetails_4 ';
   END IF;
   DELETE FROM tt_TempReturnDetails_4;
   INSERT INTO tt_TempReturnDetails_4
     ( ReturnId, ReportId, ParentReturnId )
     ( SELECT ReturnAlt_Key ,
              returnId || '-' || returnName ,
              0 
       FROM DimReturnDirectory 
       UNION 
       SELECT D.EntityKey ,
              D.ReportId ,
              DR.ReturnAlt_Key 
       FROM DynamicReportDirectory D
              JOIN ExcelTemplateDirectory ET   ON ET.ExcelId = D.ExcelId
              JOIN DimReturnDirectory DR   ON DR.ReturnAlt_Key = ET.StateAlt_Key
              AND ET.Scope = 'EBRExcelUpload'
              AND D.ReportMenuId IS NOT NULL );
   OPEN  v_cursor FOR
      SELECT ReturnId ,
             ReportId ,
             ParentReturnId 
        FROM tt_TempReturnDetails_4 
        ORDER BY ReturnId,
                 ParentReturnId ;
      DBMS_SQL.RETURN_RESULT(v_cursor);
   OPEN  v_cursor FOR
      SELECT ExcelId ,
             ReportId ,
             0 ParentReturnId  
        FROM DynamicReportDirectory 
       WHERE  NVL(Scope, ' ') <> 'EBRReportCreation'
                AND EffectiveToTimeKey = 49999 ;
      DBMS_SQL.RETURN_RESULT(v_cursor);

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "MAIN_PRO";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "MAIN_PRO";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."USERGROUPPARAMETERISEDMASTERDATA_BACKUP_11022022" TO "ADF_CDR_RBL_STGDB";
