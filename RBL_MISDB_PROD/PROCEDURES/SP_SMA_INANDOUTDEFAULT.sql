--------------------------------------------------------
--  DDL for Procedure SP_SMA_INANDOUTDEFAULT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" 
AS
   v_PrvDayTimekey NUMBER(10,0) := ( SELECT timekey - 1 
     FROM Automate_Advances 
    WHERE  EXT_FLG = 'Y' );
   -----------------------------InDefault----------------------------------------------
   v_cursor SYS_REFCURSOR;

BEGIN

   IF  --SQLDEV: NOT RECOGNIZED
   IF tt_TEMP1_20  --SQLDEV: NOT RECOGNIZED
   DELETE FROM tt_TEMP1_20;
   UTILS.IDENTITY_RESET('tt_TEMP1_20');

   INSERT INTO tt_TEMP1_20 ( 
   	SELECT A.AccountEntityID ,
           SMA_Class ,
           SMA_Dt ,
           FlgSMA ,
           DPD_SMA ,
           SMA_Reason ,
           b.DPD_MAX ,
           b.DPD_IntOverdueSince ,
           b.DPD_IntService ,
           b.DPD_NoCredit ,
           b.DPD_OtherOverdueSince ,
           b.DPD_Overdrawn ,
           b.DPD_PrincOverdue ,
           b.DPD_Overdue 
   	  FROM PRO_RBL_MISDB_PROD.AccountCal_Hist a
             LEFT JOIN PRO_RBL_MISDB_PROD.Accountcal_hist_DPD b   ON a.AccountEntityID = b.AccountEntityid
   	 WHERE  a.EffectiveFromTimeKey <= v_PrvDayTimekey
              AND a.EffectiveToTimeKey >= v_PrvDayTimekey
              AND b.TimeKey = v_PrvDayTimekey
              AND a.FinalAssetClassAlt_Key = 1 );
   UPDATE tt_TEMP1_20
      SET DPD_MAX = 0
    WHERE  DPD_MAX IS NULL;
   UPDATE tt_TEMP1_20
      SET DPD_IntOverdueSince = 0
    WHERE  DPD_IntOverdueSince IS NULL;
   UPDATE tt_TEMP1_20
      SET DPD_IntService = 0
    WHERE  DPD_IntService IS NULL;
   UPDATE tt_TEMP1_20
      SET DPD_NoCredit = 0
    WHERE  DPD_NoCredit IS NULL;
   UPDATE tt_TEMP1_20
      SET DPD_OtherOverdueSince = 0
    WHERE  DPD_OtherOverdueSince IS NULL;
   UPDATE tt_TEMP1_20
      SET DPD_Overdrawn = 0
    WHERE  DPD_Overdrawn IS NULL;
   UPDATE tt_TEMP1_20
      SET DPD_PrincOverdue = 0
    WHERE  DPD_PrincOverdue IS NULL;
   UPDATE tt_TEMP1_20
      SET DPD_Overdue = 0
    WHERE  DPD_Overdue IS NULL;
   MERGE INTO A 
   USING (SELECT A.ROWID row_id, 'FDOD'
   FROM A ,PRO_RBL_MISDB_PROD.ACCOUNTCAL a
          JOIN DimProduct b   ON a.ProductAlt_Key = b.ProductAlt_Key 
    WHERE a.FinalAssetClassAlt_Key = 1
     AND b.ProductGroup = 'FDSEC') src
   ON ( A.ROWID = src.row_id )
   WHEN MATCHED THEN UPDATE SET SMA_Class = 'FDOD';
   UPDATE PRO_RBL_MISDB_PROD.ACCOUNTCAL
      SET SMA_Class = 'Agri-Loan'
    WHERE  FinalAssetClassAlt_Key = 1
     AND RefPeriodOverdue > 91;
   OPEN  v_cursor FOR
      SELECT * 
        FROM PRO_RBL_MISDB_PROD.ACCOUNTCAL a
               JOIN tt_TEMP1_20 b   ON a.AccountEntityID = b.AccountEntityID
       WHERE  a.SMA_Class IN ( 'SMA_0','SMA_1','SMA_2' )

                AND B.SMA_Class = 'STD' ;
      DBMS_SQL.RETURN_RESULT(v_cursor);
   -----------------------------OutDefault----------------------------------------------
   OPEN  v_cursor FOR
      SELECT * 
        FROM PRO_RBL_MISDB_PROD.ACCOUNTCAL a
               JOIN tt_TEMP1_20 b   ON a.AccountEntityID = b.AccountEntityID
       WHERE  B.SMA_Class IN ( 'SMA_0','SMA_1','SMA_2' )

                AND A.SMA_Class = 'STD' ;
      DBMS_SQL.RETURN_RESULT(v_cursor);

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "MAIN_PRO";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "MAIN_PRO";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_SMA_INANDOUTDEFAULT" TO "ADF_CDR_RBL_STGDB";
