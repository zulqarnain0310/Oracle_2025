--------------------------------------------------------
--  DDL for Procedure PARAMETERISEDCOMMONMASTERDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" 
-- =============================================
 -- Author:		<Amar>
 -- ALTER  date: <09/01/2012>
 -- Description:	< selecting Master records for Parameterised_CommonMasterData>
 -- =============================================

(
  v_XMLMasterName IN VARCHAR2
)
AS
   v_Schema VARCHAR2(10);
   v_temp NUMBER(1, 0) := 0;
   v_cursor SYS_REFCURSOR;
--DECLARE @XMLMasterName AS VARCHAR(50)='DimDepartment'

BEGIN

   DBMS_OUTPUT.PUT_LINE(1);
   DBMS_OUTPUT.PUT_LINE(v_XMLMasterName);
   BEGIN
      SELECT 1 INTO v_temp
        FROM DUAL
       WHERE EXISTS ( SELECT 1 
                      FROM MetaParameterisedMasterTable 
                       WHERE  XMLTableName = v_XMLMasterName );
   EXCEPTION
      WHEN OTHERS THEN
         NULL;
   END;

   IF v_temp = 1 THEN
    DECLARE
      v_TableName VARCHAR2(50) := ' ';
      v_ColumnName VARCHAR2(2000) := ' ';
      v_InnerJoin --- edited by shailesh on 20/07/2015 as inner join is used for metacerdescription is more than 200 char
       VARCHAR2(500) := ' ';
      v_WhereCond VARCHAR2(500) := ' ';
      v_GroupBy VARCHAR2(200) := ' ';
      v_OrderBy VARCHAR2(100) := ' ';
      v_StrSql VARCHAR2(4000) := ' ';

   BEGIN
      DBMS_OUTPUT.PUT_LINE(2);
      SELECT TableName ,
             ColumnSelect ,
             InnerJoin ,
             NVL(WhereCondition, ' ') ,
             NVL(GroupBy, ' ') ,
             OrderBy 

        INTO v_TableName,
             v_ColumnName,
             v_InnerJoin,
             v_WhereCond,
             v_GroupBy,
             v_OrderBy
        FROM MetaParameterisedMasterTable 
       WHERE  XMLTableName = v_XMLMasterName;
      SELECT /*TODO:SQLDEV*/ SCHEMA_NAME(SCHEMA_ID) /*END:SQLDEV*/ || '.' 

        INTO v_Schema
        FROM SYS.OBJECTS 
       WHERE  NAME = v_TableName;---- AND SCHEMA_NAME(SCHEMA_ID) in('DBO')----by dipti
      DBMS_OUTPUT.PUT_LINE('@Schema');
      DBMS_OUTPUT.PUT_LINE(v_Schema);
      IF NVL(v_Schema, ' ') = ' ' THEN
       v_Schema := ' ' ;
      END IF;
      DBMS_OUTPUT.PUT_LINE('@TableName ' || v_TableName);
      DBMS_OUTPUT.PUT_LINE('@ColumnName' || v_ColumnName);
      DBMS_OUTPUT.PUT_LINE('@InnerJoin' || v_InnerJoin);
      DBMS_OUTPUT.PUT_LINE('@WhereCond' || v_WhereCond);
      DBMS_OUTPUT.PUT_LINE('@OrderBy' || v_OrderBy);
      DBMS_OUTPUT.PUT_LINE(11);
      v_StrSql := 'SELECT distinct ''' || v_XMLMasterName || '''TableName,' || v_ColumnName || ' FROM ' || v_Schema || v_TableName || ' ' || NVL(v_InnerJoin, ' ') || ' ' || NVL(v_WhereCond, ' ') || 
      ----	+ ' '+ISNULL(@GroupBy,'')
      ' ' || NVL(v_OrderBy, ' ') ;
      DBMS_OUTPUT.PUT_LINE(12);
      DBMS_OUTPUT.PUT_LINE(v_StrSql);
      DBMS_OUTPUT.PUT_LINE(13);
      OPEN cv_1 FOR
      v_StrSql;

   END;
   END IF;

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "MAIN_PRO";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "MAIN_PRO";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."PARAMETERISEDCOMMONMASTERDATA" TO "ADF_CDR_RBL_STGDB";
