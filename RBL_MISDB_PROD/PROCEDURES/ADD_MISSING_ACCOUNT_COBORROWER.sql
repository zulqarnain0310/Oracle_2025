--------------------------------------------------------
--  DDL for Procedure ADD_MISSING_ACCOUNT_COBORROWER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" 
AS
   v_Time NUMBER(10,0) ;

BEGIN

   SELECT TIMEKEY INTO v_Time 
     FROM Automate_Advances 
    WHERE  EXT_FLG = 'Y' ;

   DELETE FROM GTT_leftaccounts;
   UTILS.IDENTITY_RESET('GTT_leftaccounts');

   INSERT INTO GTT_leftaccounts (UCIF_ID ,CustomerAcID ,RefCustomerID )
          SELECT A.UCIF_ID ,
                                                      A.CustomerAcID ,
                                                      RefCustomerID 
        FROM GTT_AccountCal A
       WHERE  EXISTS ( SELECT 1 
                       FROM RBL_MISDB_PROD.CoBorrowerData B
                        WHERE  A.UCIF_ID = B.UCIC
                                 AND TIMEKEY = v_Time )
        GROUP BY A.UCIF_ID,A.CustomerAcID,RefCustomerID 
         MINUS 
         SELECT UCIC ,
                CustomerAcID ,
                CustomerID 
           FROM RBL_MISDB_PROD.CoBorrowerData 
          WHERE  TIMEKEY = v_Time
         ;

   MERGE INTO GTT_leftaccounts A
   USING (SELECT A.ROWID row_id, B.Cohort_No, B.TimeKey
   FROM GTT_leftaccounts A
          JOIN RBL_MISDB_PROD.CoBorrowerData B   ON A.UCIF_ID = B.UCIC 
    WHERE A.Cohort_No IS NULL
     AND b.TimeKey = v_Time) src
   ON ( A.ROWID = src.row_id )
   WHEN MATCHED THEN UPDATE SET A.COHORT_NO = src.Cohort_No,
                                A.TIMEKEY = src.TimeKey;
   INSERT INTO MAIN_PRO.CoBorrowerCal
     ( CustomerACID, UCIC, CustomerID, CustomerType, Cohort_No, TimeKey )
     ( SELECT CustomerACID ,
              UCIF_ID ,
              RefCustomerID ,
              'Link' CustomerType  ,
              COHORT_NO ,
              TimeKey 
       FROM GTT_leftaccounts  );

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "MAIN_PRO";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "MAIN_PRO";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ADD_MISSING_ACCOUNT_COBORROWER" TO "ADF_CDR_RBL_STGDB";
