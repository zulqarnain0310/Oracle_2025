--------------------------------------------------------
--  DDL for Procedure RPT_SYSREPORTVERSION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" 
(
  v_ReportName IN VARCHAR2,
  v_TimeKey IN NUMBER
)
AS
   v_reptitle VARCHAR2(4000);
   v_value NUMBER(10,0);
   v_cursor SYS_REFCURSOR;

BEGIN

   v_reptitle := SUBSTR(v_reportname, -INSTR(utils.reverse_(v_reportname), '-') - 1, INSTR(utils.reverse_(v_reportname), '-') - 1) ;
   SELECT CASE 
               WHEN ( SELECT ReportRdlName 
                      FROM SysReportDirectory 
                       WHERE  EffectiveFromTimeKey <= v_timekey
                                AND EffectiveToTimeKey >= v_timekey
                                AND ReportRdlName = v_reptitle 
                        FETCH FIRST 1 ROWS ONLY ) = v_reptitle THEN 1
          ELSE 2
             END col  

     INTO v_value
     FROM DUAL ;
   IF v_value = 1 THEN

   BEGIN
      OPEN  v_cursor FOR
         SELECT ('Version No. : ' || VersionNo) versionno  ,
                ('Report ID : ' || ExportReportId) reportid  ,
                Frequency_Period ,
                CASE 
                     WHEN ReportType = 1 THEN 'Summary'
                     WHEN ReportType = 2 THEN 'Details'
                     WHEN ReportType = 3 THEN 'SummaryDetails'
                     WHEN ReportType = 7 THEN 'Summary'
                     WHEN ReportType = 8 THEN 'Details'
                     WHEN ReportType = 9 THEN 'SummaryDetails'   END ReportTypeLabel  ,
                ReportType ReportTypeValue  
           FROM SysReportDirectory SRD
          WHERE  SRD.EffectiveFromTimeKey <= v_timekey
                   AND SRD.EffectiveToTimeKey >= v_timekey
                   AND SRD.ReportRdlName = v_reptitle 
           FETCH FIRST 1 ROWS ONLY ;
         DBMS_SQL.RETURN_RESULT(v_cursor);

   END;
   END IF;
   IF v_value = 2 THEN

   BEGIN
      OPEN  v_cursor FOR
         SELECT ('Version No. : ' || VersionNo) versionno  ,
                ('Report ID : ' || ReportID) reportid  ,
                CASE 
                     WHEN ReportType = 1 THEN 'Summary'
                ELSE 'Details'
                   END ReportTypeLabel  ,
                CASE 
                     WHEN ReportType = 1 THEN '1'
                ELSE '2'
                   END ReportTypeValue  
           FROM SysValidationReport 
          WHERE  EffectiveFromTimeKey <= v_timekey
                   AND EffectiveToTimeKey >= v_timekey
                   AND ReportRdlName = v_reptitle 
           FETCH FIRST 1 ROWS ONLY ;
         DBMS_SQL.RETURN_RESULT(v_cursor);

   END;
   ELSE

   BEGIN
      OPEN  v_cursor FOR
         SELECT ' ' versionno  
           FROM DUAL  ;
         DBMS_SQL.RETURN_RESULT(v_cursor);

   END;
   END IF;

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "MAIN_PRO";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "MAIN_PRO";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."RPT_SYSREPORTVERSION" TO "ADF_CDR_RBL_STGDB";
