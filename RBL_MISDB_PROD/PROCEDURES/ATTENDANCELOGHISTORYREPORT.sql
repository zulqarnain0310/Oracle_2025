--------------------------------------------------------
--  DDL for Procedure ATTENDANCELOGHISTORYREPORT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" 
(
  iv_FromDate IN VARCHAR2,
  iv_ToDate IN VARCHAR2
)
AS
   v_FromDate VARCHAR2(10) := iv_FromDate;
   v_ToDate VARCHAR2(10) := iv_ToDate;
   v_cursor SYS_REFCURSOR;
--DECLARE
--	@FromDate varchar(10)=N'01/12/2022',
--	@ToDate varchar(10)=N'26/04/2023'

BEGIN

   v_FromDate := UTILS.CONVERT_TO_VARCHAR2(v_FromDate,200,p_style=>105) ;
   v_ToDate := UTILS.CONVERT_TO_VARCHAR2(v_ToDate,200,p_style=>105) ;
   IF utils.object_id('TEMPDB..GTT_DimUserInfo') IS NOT NULL THEN
    EXECUTE IMMEDIATE ' TRUNCATE TABLE GTT_DimUserInfo ';
   END IF;
   DELETE FROM GTT_DimUserInfo;
   UTILS.IDENTITY_RESET('GTT_DimUserInfo');

   INSERT INTO GTT_DimUserInfo SELECT * 
        FROM ( SELECT ENTITYKEY,	USERLOGINID,	USERNAME,	LOGINPASSWORD,	PASSWORDCHANGED,	PASSWORDCHANGEDATE,	CHANGEPWDCNT,	USERLOCATION,	USERLOCATIONCODE,	USERROLEALT_KEY,	SUSPENDEDUSER,	CURRENTLOGINDATE,	RESETDATE,	ACTIVATE,	USERLOGGED,	USERDELETIONREASONALT_KEY,	SYSTEMLOGOUT,	EMPLOYEEID,	USERTYPE,	ISEMPLOYEE,	ISCHECKER,	RBIFLAG,	DEPTGROUPCODE,	EMAIL_ID,	SECURITQSNALT_KEY,	SECURITYANS,	MENUID,	AUTHORISATIONSTATUS,	EFFECTIVEFROMTIMEKEY,	EFFECTIVETOTIMEKEY,	CREATEDBY,	DATECREATED,	MODIFYBY,	DATEMODIFIED,	APPROVEDBY,	DATEAPPROVED,	D2KTIMESTAMP,	MIS_APP_USR_ID,	MIS_APP_USR_PASS,	USERLOCATIONEXCEL,	DESIGNATIONALT_KEY,	MOBILENO,	ISCMA,	SSOUSE,	SESSIONID,	PROFFENTITYID,	GRADESCALEALT_KEY,	EMPLOYEETYPEALT_KEY,	ISREPORT,	USERACTIVATIONDATE,	USERDEACTIVATIONDATE,	WORKFLOWUSERROLEALT_KEY,	DEPARTMENTID,	APPLICABLESOLIDS,	APPLICABLEBACID,	SCREENFLAG,	ISCHECKER2,	EXTENSION,	DESIGNATION,	LASTREQUESTTIME,
                      ROW_NUMBER() OVER ( PARTITION BY UserLoginid ORDER BY EffectiveFromTimeKey DESC, EntityKey DESC  ) RN  
               FROM DimUserInfo  ) A
       WHERE  RN = 1;
   IF utils.object_id('TEMPDB..GTT_LogAttendance') IS NOT NULL THEN
    EXECUTE IMMEDIATE ' TRUNCATE TABLE GTT_LogAttendance ';
   END IF;
   DELETE FROM GTT_LogAttendance;
   UTILS.IDENTITY_RESET('GTT_LogAttendance');

   INSERT INTO GTT_LogAttendance SELECT DISTINCT LogCreatedBy UserID  ,
                                                C.UserName ,
                                                Email_ID ,
                                                Designation ,
                                                D.RoleDescription ,
                                                DUDept.DeptGroupName ,
                                                a.MenuID ,
                                                b.ScreenName ,
                                                LogCreationStatus ,
                                                CASE 
                                                     WHEN LogCreationStatus = 'NP' THEN 'New Record Inserted'
                                                     WHEN LogCreationStatus = 'MP' THEN 'Modify Record'
                                                     WHEN LogCreationStatus = '1A' THEN '1st Level Authorise'
                                                     WHEN LogCreationStatus = 'R' THEN 'Reject Record'
                                                ELSE '2nd Level Authorise'
                                                   END LogCreationStatusDescription  ,
                                                --,LogCreatedDt
                                                (UTILS.CONVERT_TO_VARCHAR2(LogCreatedDt,10,p_style=>105) || ' ' || UTILS.CONVERT_TO_VARCHAR2(LogCreatedDt,30,p_style=>108)) LogCreatedDt  ,
                                                LogStatus ,
                                                CASE 
                                                     WHEN LogStatus = 'P' THEN 'Pending Status'
                                                     WHEN LogStatus = 'R' THEN 'Reject Status'
                                                ELSE 'Approve Status'
                                                   END LogStatusDescription  ,
                                                A.EntityKey 
        FROM SysUserActivityLog_Attendence a
               JOIN MetaScreenFieldDetail b   ON a.MenuID = b.MenuId
               JOIN GTT_DimUserInfo c   ON a.LogCreatedBy = c.UserLoginID
               JOIN DimUserRole D   ON C.UserRoleAlt_Key = D.UserRoleAlt_Key
               LEFT JOIN DimUserDeptGroup DUDept   ON C.DeptGroupCode = DUDept.DeptGroupId
               AND DUDept.EffectiveToTimeKey = 49999

      --where			a.LogCreatedDt between @FromDate and @ToDate
      WHERE  UTILS.CONVERT_TO_VARCHAR2(a.LogCreatedDt,200) >= v_FromDate
               AND UTILS.CONVERT_TO_VARCHAR2(a.LogCreatedDt,200) <= v_ToDate
        ORDER BY 14 DESC;
   --select * from DimUserInfo
   --select distinct LogStatus from SysUserActivityLog_Attendence
   
    delete from GTT_LogAttendance
     where rowid IN ( select RN
                        from (SELECT USERID,	USERNAME,	EMAIL_ID,	DESIGNATION,	ROLEDESCRIPTION,	DEPTGROUPNAME,	MENUID,	SCREENNAME,	LOGCREATIONSTATUS,	LOGCREATIONSTATUSDESCRIPTION,	LOGCREATEDDT,	LOGSTATUS,	LOGSTATUSDESCRIPTION,	ENTITYKEY,
                                          ROW_NUMBER() OVER ( PARTITION BY UserID, MenuID, LogCreatedDt ORDER BY LogCreatedDt DESC  ) RN  
                                from GTT_LogAttendance)
                       where rn <> 1);      
      
   OPEN  v_cursor FOR
      SELECT UserID ,
             UserName ,
             Email_ID ,
             Designation ,
             RoleDescription ,
             DeptGroupName ,
             MenuID ,
             ScreenName ,
             LogCreationStatus ,
             LogCreationStatusDescription ,
             LogCreatedDt ,
             LogStatus ,
             LogStatusDescription 
        FROM GTT_LogAttendance 
        ORDER BY EntityKey DESC ;
      DBMS_SQL.RETURN_RESULT(v_cursor);

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "MAIN_PRO";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "MAIN_PRO";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."ATTENDANCELOGHISTORYREPORT" TO "ADF_CDR_RBL_STGDB";
