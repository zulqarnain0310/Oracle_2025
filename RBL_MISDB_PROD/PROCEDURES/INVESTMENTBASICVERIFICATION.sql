--------------------------------------------------------
--  DDL for Procedure INVESTMENTBASICVERIFICATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" /****** Object:  StoredProcedure [dbo].[InvestmentBasicVerification]    Script Date: 9/24/2021 8:20:04 PM ******/
--DROP PROCEDURE [dbo].[InvestmentBasicVerification]
 --GO
 --/****** Object:  StoredProcedure [dbo].[InvestmentBasicVerification]    Script Date: 9/24/2021 8:20:04 PM ******/
 --SET ANSI_NULLS ON
 --GO
 --SET QUOTED_IDENTIFIER ON
 --GO
 ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 --exec [InvestmentbasicVerification] '2001' 

(
  v_InvID IN VARCHAR2 DEFAULT ' ' 
)
AS
   v_TimeKey NUMBER(10,0);
   v_temp NUMBER(1, 0) := 0;
   v_cursor SYS_REFCURSOR;

BEGIN

   SELECT Timekey 

     INTO v_Timekey
     FROM SysDataMatrix 
    WHERE  CurrentStatus = 'C';
   BEGIN
      SELECT 1 INTO v_temp
        FROM DUAL
       WHERE NOT EXISTS ( SELECT 1 
                          FROM CurDat_RBL_MISDB_PROD.InvestmentBasicDetail A
                                 LEFT JOIN CurDat_RBL_MISDB_PROD.InvestmentIssuerDetail B   ON A.RefIssuerID = B.IssuerID
                           WHERE  ( A.EffectiveFromTimeKey <= v_TimeKey
                                    AND A.EffectiveToTimeKey >= v_TimeKey )
                                    AND A.InvID = v_InvID
                                    AND NVL(A.AuthorisationStatus, 'A') = 'A' );
   EXCEPTION
      WHEN OTHERS THEN
         NULL;
   END;

   IF v_temp = 1 THEN

   BEGIN
      DELETE FROM tt_temp1_8;
      UTILS.IDENTITY_RESET('tt_temp1_8');

      INSERT INTO tt_temp1_8 ( 
      	SELECT A.* ,
              IssuerID ,
              IssuerName ,
              InstrumentTypeName ,
              IndustryName 
      	  FROM CurDat_RBL_MISDB_PROD.InvestmentBasicDetail A
                LEFT JOIN CurDat_RBL_MISDB_PROD.InvestmentIssuerDetail B   ON A.RefIssuerID = B.IssuerID
                LEFT JOIN DimInstrumentType C   ON A.InstrTypeAlt_Key = C.InstrumentTypeAlt_Key
                LEFT JOIN DimIndustry D   ON A.Industry_AltKey = D.IndustryAlt_Key
      	 WHERE  ( A.EffectiveFromTimeKey <= v_TimeKey
                 AND A.EffectiveToTimeKey >= v_TimeKey )
                 AND A.InvId = v_InvID
                 AND NVL(A.AuthorisationStatus, 'A') = 'A' );
      OPEN  v_cursor FOR
         SELECT ( SELECT ROW_NUMBER() OVER ( ORDER BY InvEntityID  ) RowNumber  
                    FROM DUAL  ) ,
                COUNT(*) OVER ( ) TotalCount  ,
                'InvestmentCodeMaster' TableName  ,
                * 
           FROM tt_temp1_8  ;
         DBMS_SQL.RETURN_RESULT(v_cursor);

   END;
   ELSE

   BEGIN
      DELETE FROM tt_temp_170;
      UTILS.IDENTITY_RESET('tt_temp_170');

      INSERT INTO tt_temp_170 ( 
      	SELECT A.* ,
              IssuerID ,
              IssuerName ,
              InstrumentTypeName ,
              IndustryName 
      	  FROM CurDat_RBL_MISDB_PROD.InvestmentBasicDetail A
                LEFT JOIN CurDat_RBL_MISDB_PROD.InvestmentIssuerDetail B   ON A.RefIssuerID = B.IssuerID
                LEFT JOIN DimInstrumentType C   ON A.InstrTypeAlt_Key = C.InstrumentTypeAlt_Key
                LEFT JOIN DimIndustry D   ON A.Industry_AltKey = D.IndustryAlt_Key
      	 WHERE  ( A.EffectiveFromTimeKey <= v_TimeKey
                 AND A.EffectiveToTimeKey >= v_TimeKey )
                 AND A.InvId = v_InvID
                 AND NVL(A.AuthorisationStatus, 'A') = 'A' );
      OPEN  v_cursor FOR
         SELECT ( SELECT ROW_NUMBER() OVER ( ORDER BY InvEntityID  ) RowNumber  
                    FROM DUAL  ) ,
                COUNT(*) OVER ( ) TotalCount  ,
                'InvestmentCodeMaster' TableName  ,
                * 
           FROM tt_temp_170  ;
         DBMS_SQL.RETURN_RESULT(v_cursor);

   END;
   END IF;

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "MAIN_PRO";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "MAIN_PRO";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."INVESTMENTBASICVERIFICATION" TO "ADF_CDR_RBL_STGDB";
