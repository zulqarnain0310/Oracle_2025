--------------------------------------------------------
--  DDL for Procedure SP_MOCDATALEVELVALIDATION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" 
AS
   v_cursor SYS_REFCURSOR;

BEGIN

   ------------------------CUSTOMER LEVEL MOC VERIFICATION
   OPEN  v_cursor FOR
      SELECT UCIFEntityid ,
             A.CustomerEntityID ,
             SysAssetClassAlt_Key ,
             AssetClassAlt_Key ,
             A.NPA_Date ,
             B.SysNPA_Dt ,
             (CASE 
                   WHEN C.RefCustomerId IS NOT NULL THEN 'Y'
             ELSE 'N'
                END) RestrcFlg  ,
             Asset_Norm 
        FROM MOC_ChangeDetails A
               JOIN PRO_RBL_MISDB_PROD.CUSTOMERCAL B   ON A.CustomerEntityID = B.CustomerEntityID
               LEFT JOIN CurDat_RBL_MISDB_PROD.AdvAcRestructureDetail C   ON B.RefCustomerID = C.RefCustomerId
               AND C.EffectiveToTimeKey = 49999
       WHERE  A.EffectiveFromTimeKey <= 26267
                AND A.EffectiveToTimeKey >= 26267

                --and B.EffectiveFromTimeKey<=26288 and B.EffectiveToTimeKey>=26288
                AND MOCType_Flag = 'CUST'
                AND AssetClassAlt_Key IS NOT NULL
                AND C.RefCustomerId IS NULL

                --and cast(MOC_Date as date) = '11/30/2021'

                --and A.AssetClassAlt_Key!=B.SysAssetClassAlt_Key
                AND NPA_Date != SysNPA_Dt
        ORDER BY UCIFEntityid,
                 A.CustomerEntityID ;
      DBMS_SQL.RETURN_RESULT(v_cursor);
   ------------------------ACCOUNT LEVEL MOC VERIFICATION
   OPEN  v_cursor FOR
      SELECT UCIFEntityid ,
             B.CustomerEntityID ,
             B.RefCustomerID ,
             B.AccountEntityID ,
             B.CustomerAcID FinalAssetClassAlt_Key  ,
             AssetClassAlt_Key ,
             A.NPA_Date ,
             B.FinalNpaDt ,
             Asset_Norm ,
             (CASE 
                   WHEN C.RefCustomerId IS NOT NULL THEN 'Y'
             ELSE 'N'
                END) RestrcFlg  
        FROM MOC_ChangeDetails A
               JOIN PRO_RBL_MISDB_PROD.ACCOUNTCAL B   ON A.CustomerEntityID = B.CustomerEntityID
               LEFT JOIN CurDat_RBL_MISDB_PROD.AdvAcRestructureDetail C   ON B.RefCustomerID = C.RefCustomerId
               AND C.EffectiveToTimeKey = 49999
       WHERE  A.EffectiveFromTimeKey <= 26267
                AND A.EffectiveToTimeKey >= 26267

                --and B.EffectiveFromTimeKey<=26267 and B.EffectiveToTimeKey>=26267
                AND MOCType_Flag = 'CUST'
                AND AssetClassAlt_Key IS NOT NULL
                AND C.AccountEntityId IS NULL
              --and cast(MOC_Date as date) = '11/30/2021'
               --and A.NPA_Date!=B.FinalNpaDt

        ORDER BY UCIFEntityid,
                 A.CustomerEntityID ;
      DBMS_SQL.RETURN_RESULT(v_cursor);
   OPEN  v_cursor FOR
      SELECT * 
        FROM MOC_ChangeDetails 
       WHERE  CustomerEntityID IN ( 1389484 )
    ;
      DBMS_SQL.RETURN_RESULT(v_cursor);
   OPEN  v_cursor FOR
      SELECT FLGMOC ,
             SysNPA_Dt ,
             SysAssetClassAlt_Key ,
             * 
        FROM PRO_RBL_MISDB_PROD.CUSTOMERCAL 
       WHERE  UCIF_ID = 'RBL000004524' ;
      DBMS_SQL.RETURN_RESULT(v_cursor);
   ------------------MOC IMPACTED ACCOUNTS COUNT
   OPEN  v_cursor FOR
      SELECT COUNT(DISTINCT CustomerAcID)  accno  
        FROM PRO_RBL_MISDB_PROD.ACCOUNTCAL 
       WHERE  UcifEntityID IN ( SELECT UcifEntityID 
                                FROM CustomerBasicDetail 
                                 WHERE  CustomerEntityId IN ( SELECT DISTINCT CustomerEntityID 
                                                              FROM MOC_ChangeDetails 
                                                               WHERE  EffectiveFromTimeKey = 26267 )
               )
    ;
      DBMS_SQL.RETURN_RESULT(v_cursor);

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "MAIN_PRO";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "MAIN_PRO";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_MOCDATALEVELVALIDATION" TO "ADF_CDR_RBL_STGDB";
