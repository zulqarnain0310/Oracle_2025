--------------------------------------------------------
--  DDL for Procedure COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" 
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

(
  --Declare--@PageNo         INT         = 1, --@PageSize       INT         = 10, --@OperationFlag  INT         = 1  --,--,@CustomerID	Varchar(100)	= NULL
  v_TaggingId IN VARCHAR2 DEFAULT NULL ,
  --,@UCICID		Varchar(12)	=	NULL
  v_Cust_AcID_UCIF IN VARCHAR2 DEFAULT NULL 
)
AS
   --BEGIN
   v_TimeKey NUMBER(10,0);
   v_cursor SYS_REFCURSOR;

BEGIN

   SELECT Timekey 

     INTO v_Timekey
     FROM SysDataMatrix 
    WHERE  CurrentStatus = 'C';
   IF utils.object_id('TempDB..tt_temp_82') IS NOT NULL THEN
    EXECUTE IMMEDIATE ' TRUNCATE TABLE tt_temp_82 ';
   END IF;
   DELETE FROM tt_temp_82;
   UTILS.IDENTITY_RESET('tt_temp_82');

   INSERT INTO tt_temp_82 ( 
   	SELECT B.RefSystemAcId ,
           B.UCICID ,
           B.RefCustomerId ,
           A.CollateralID ,
           B.CollateralValueatSanctioninRs CollateralValueatSanctioninRs  ,
           B.CollateralValueasonNPAdateinRs CollateralValueasonNPAdateinRs  ,
           A.CurrentValue CollateralValueatthetimeoflastreviewinRs  ,
           --,A.ValuationSourceNameAlt_Key
           --,B.SourceName
           UTILS.CONVERT_TO_VARCHAR2(A.ValuationDate,20,p_style=>103) ValuationDate  ,
           A.CurrentValue LatestCollateralValueinRs  ,
           A.ExpiryBusinessRule ,
           A.Periodinmonth ,
           UTILS.CONVERT_TO_VARCHAR2(A.ValuationExpiryDate,20,p_style=>103) ValueExpirationDate  ,
           --,C.ParameterName AS DisplayCollateralFor
           B.TaggingAlt_Key ,
           NVL(A.AuthorisationStatus, 'A') AuthorisationStatus  ,
           A.EffectiveFromTimeKey ,
           A.EffectiveToTimeKey ,
           A.CreatedBy ,
           A.DateCreated ,
           A.ApprovedBy ,
           A.DateApproved ,
           A.ModifiedBy ,
           A.DateModified ,
           (CASE 
                 WHEN B.TaggingAlt_Key = 1 THEN B.RefCustomerId
                 WHEN B.TaggingAlt_Key = 2 THEN B.RefSystemAcId
                 WHEN B.TaggingAlt_Key = 4 THEN B.UCICID   END) TaggingId  ,
           'CollateralSearchGridData' TableName  
   	  FROM CurDat_RBL_MISDB_PROD.AdvSecurityDetail B
             LEFT JOIN CurDat_RBL_MISDB_PROD.AdvSecurityValueDetail A   ON A.CollateralID = B.CollateralID
             JOIN DimParameter C   ON B.TaggingAlt_Key = C.ParameterAlt_Key
             AND C.DimParameterName = 'DimRatingType'
   	 WHERE  B.EffectiveFromTimeKey <= v_TimeKey
              AND B.EffectiveToTimeKey >= v_TimeKey
              AND A.EffectiveFromTimeKey <= v_TimeKey
              AND A.EffectiveToTimeKey >= v_TimeKey
              AND NVL(A.AuthorisationStatus, 'A') = 'A'
              AND v_TaggingId = C.ParameterAlt_Key
              AND ( v_TaggingId = 1
              AND B.RefCustomerId = v_Cust_AcID_UCIF
              OR v_TaggingId = 2
              AND B.RefSystemAcId = v_Cust_AcID_UCIF
              OR v_TaggingId = 4
              AND B.UCICID = v_Cust_AcID_UCIF ) );
   OPEN  v_cursor FOR
      SELECT * 
        FROM tt_temp_82  ;
      DBMS_SQL.RETURN_RESULT(v_cursor);--select * from CollateralValueDetails
   --select * from CollateralMgmt
   --select * from DimParameter where DimParameterName='DimRatingType' 

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "MAIN_PRO";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "MAIN_PRO";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."COLLATERALVALUEENQUIRESEARCHTAGGINGLIST_01102021" TO "ADF_CDR_RBL_STGDB";
