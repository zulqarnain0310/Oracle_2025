--------------------------------------------------------
--  DDL for Function SP_UPGRADDIAGRAMS
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" 
RETURN NUMBER
AS

BEGIN

   IF utils.object_id(u'dbo.sysdiagrams') IS NOT NULL THEN
    RETURN 0;
   END IF;
   DELETE FROM RBL_MISDB_PROD.sysdiagrams;
   -- we may change it to varbinary(85)
   /* Add this if we need to have some form of extended properties for diagrams */
   /*
   		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
   		BEGIN
   			CREATE TABLE dbo.sysdiagram_properties
   			(
   				diagram_id int,
   				name sysname,
   				value varbinary(max) NOT NULL
   			)
   		END
   		*/
   IF utils.object_id(u'dbo.dtproperties') IS NOT NULL THEN

   BEGIN
      INSERT INTO RBL_MISDB_PROD.sysdiagrams
        ( name, principal_id, version, definition )
        ( SELECT UTILS.CONVERT_TO_VARCHAR2(dgnm.uvalue,128) ,
                 DATABASE_PRINCIPAL_ID(u'dbo' 
                 ) ,-- will change to the sid of sa

                 0 ,-- zero for old format, dgdef.[version],

                 dgdef.lvalue 
          FROM RBL_MISDB_PROD.dtproperties dgnm
                 JOIN RBL_MISDB_PROD.dtproperties dggd   ON dggd.property = 'DtgSchemaGUID'
                 AND dggd.objectid = dgnm.objectid
                 JOIN RBL_MISDB_PROD.dtproperties dgdef   ON dgdef.property = 'DtgSchemaDATA'
                 AND dgdef.objectid = dgnm.objectid
           WHERE  dgnm.property = 'DtgSchemaNAME'
                    AND dggd.uvalue LIKE u'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' );
      RETURN 2;

   END;
   END IF;
   RETURN 1;

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "MAIN_PRO";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "MAIN_PRO";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "RBL_TEMPDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "RBL_MISDB_PROD"."SP_UPGRADDIAGRAMS" TO "ADF_CDR_RBL_STGDB";
