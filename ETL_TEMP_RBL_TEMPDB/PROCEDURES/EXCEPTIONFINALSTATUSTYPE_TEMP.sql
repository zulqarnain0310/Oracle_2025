--------------------------------------------------------
--  DDL for Procedure EXCEPTIONFINALSTATUSTYPE_TEMP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" 
AS
   v_vEffectivefrom NUMBER(10,0);
   v_TimeKey NUMBER(10,0);
   v_DATE VARCHAR2(200) ;

BEGIN

   SELECT Date_ INTO v_DATE
     FROM RBL_MISDB_PROD.Automate_Advances 
    WHERE  EXT_FLG = 'Y' ;

   SELECT TimeKey 

     INTO v_vEffectiveFrom
     FROM RBL_MISDB_PROD.Automate_Advances 
    WHERE  EXT_FLG = 'Y';
   SELECT TimeKey 

     INTO v_TimeKey
     FROM RBL_MISDB_PROD.Automate_Advances 
    WHERE  EXT_FLG = 'Y';
   -------------------------------------------------------------------------------------------------------------
   DELETE FROM tt_temp_133;
   UTILS.IDENTITY_RESET('tt_temp_133');

   INSERT INTO tt_temp_133 ( 
   	SELECT CustomerACID ,
           MIN(StatusDate)  MinDate  
   	  FROM RBL_STGDB.ExceptionFinalStatusType_AllData 
   	  GROUP BY CustomerACID );
   EXECUTE IMMEDIATE ' TRUNCATE TABLE RBL_TEMPDB.Temp_ExceptionFinalStatusTypeData ';
   INSERT INTO RBL_TEMPDB.Temp_ExceptionFinalStatusTypeData
     ( CustomerACID, CustomerID, UCIC, Flag, Amount, HostSystem, StatusDate, StatusType, AccountEntityId, EffectiveFromTimeKey, EffectiveToTimeKey, SourceAlt_Key )
     ( 
       -------------    FINACLE  ---------  
       SELECT CustomerACID ,
              CustomerID ,
              UCIC ,
              Flag ,
              Amount ,
              HostSystem ,
              UTILS.CONVERT_TO_VARCHAR2(StatusDate,200) StatusDate  ,
              StatusType ,
              NULL AccountEntityId  ,
              v_TimeKey ,
              49999 ,
              B.SourceAlt_Key 
       FROM RBL_STGDB.ExceptionFinalStatusType_AllData A
              JOIN RBL_MISDB_PROD.DIMSOURCEDB B   ON A.HostSystem = B.SourceName
              AND B.EffectiveToTimeKey = 49999 );
   MERGE INTO RBL_STGDB.ExceptionFinalStatusType_AllData A
   USING (SELECT A.ROWID row_id, B.MinDate
   FROM RBL_STGDB.ExceptionFinalStatusType_AllData A
          JOIN tt_temp_133 B   ON A.CustomerACID = B.CustomerACID ) src
   ON ( A.ROWID = src.row_id )
   WHEN MATCHED THEN UPDATE SET A.StatusDate = src.MinDate;
   ---GO  
   /*********************************************************************************************************/
   /*  Existing Customers Account Entity ID Update  */
   MERGE INTO RBL_TEMPDB.Temp_ExceptionFinalStatusTypeData TEMP
   USING (SELECT TEMP.ROWID row_id, MAIN.AccountEntityId
   FROM RBL_TEMPDB.Temp_ExceptionFinalStatusTypeData TEMP
          JOIN RBL_MISDB_PROD.AdvAcBasicDetail MAIN   ON TEMP.CustomerAcId = MAIN.CustomerAcId 
    WHERE MAIN.EffectiveToTimeKey = 49999) src
   ON ( TEMP.ROWID = src.row_id )
   WHEN MATCHED THEN UPDATE SET TEMP.AccountEntityId = src.AccountEntityId;
   --UPDATE TEMP   
   --SET TEMP.AccountEntityId=MAIN.IssuerEntityId   
   --FROM [dbo].[Temp_ExceptionFinalStatusTypeData]   TEMP  
   --INNER JOIN  RBL_MISDB_PROD.[DBO].[InvestmentIssuerDetail] MAIN ON TEMP.CustomerAcId=MAIN.[IssuerID]  
   --WHERE MAIN.EffectiveToTimeKey=49999  
   --and temp.SourceAlt_Key=7
   --UPDATE TEMP   
   --SET TEMP.[IssuerEntityId]=MAIN.[IssuerEntityId]  
   --FROM  [RBL_TEMPDB].[DBO].[CalypsoSettlementData]  TEMP  
   --INNER JOIN  RBL_MISDB_PROD.[DBO].[InvestmentIssuerDetail] MAIN ON TEMP.[IssuerID]=MAIN.[IssuerID]  
   --WHERE MAIN.EffectiveToTimeKey=49999 
   UPDATE RBL_TEMPDB.Temp_ExceptionFinalStatusTypeData
      SET StatusDate = v_date
    WHERE  StatusDate IS NULL;

EXCEPTION WHEN NO_DATA_FOUND THEN DBMS_OUTPUT.PUT_LINE('NO DATA FOUND');
            WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "MAIN_PRO";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "RBL_STGDB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "MAIN_PRO";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "RBL_STGDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "RBL_TEMPDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."EXCEPTIONFINALSTATUSTYPE_TEMP" TO "ADF_CDR_RBL_STGDB";
