--------------------------------------------------------
--  DDL for Procedure ADVACBALANCEDETAIL_TEMP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" 
-- =============================================  
 -- Author:  <Author,,Name>  
 -- Create date: <Create Date,,>  
 -- Description: <Description,,>  
 -- =============================================  

AS
   v_vEffectivefrom NUMBER(10,0);
   v_TimeKey NUMBER(10,0);
   v_DATE VARCHAR2(200) ;
-- Add the parameters for the stored procedure here  

BEGIN

    SELECT Date_ INTO v_DATE 
     FROM RBL_MISDB_PROD.Automate_Advances 
    WHERE  EXT_FLG = 'Y' ;

   -- SET NOCOUNT ON added to prevent extra result sets from  
   -- interfering with SELECT statements.  
   -- Insert statements for procedure here  
   EXECUTE IMMEDIATE ' TRUNCATE TABLE TEMPADVACBALANCEDETAIL ';
   SELECT TimeKey 

     INTO v_vEffectiveFrom
     FROM RBL_MISDB_PROD.Automate_Advances 
    WHERE  EXT_FLG = 'Y';
   SELECT TimeKey 

     INTO v_TimeKey
     FROM RBL_MISDB_PROD.Automate_Advances 
    WHERE  EXT_FLG = 'Y';

   ----------------------------------------------------------------------------------------------------------------------------------------------------  
   /* For All Accounts */
   INSERT INTO RBL_TEMPDB.TEMPADVACBALANCEDETAIL
     ( ACCOUNTENTITYID, ASSETCLASSALT_KEY, BALANCEINCURRENCY, BALANCE, SIGNBALANCE, LASTCRDT, OVERDUE, TOTALPROV
   --,DIRECTBALANCE  
    --,INDIRECTBALANCE  
    --,LASTCRAMT  
   , REFCUSTOMERID, REFSYSTEMACID, AUTHORISATIONSTATUS, EFFECTIVEFROMTIMEKEY, EFFECTIVETOTIMEKEY, OVERDUESINCEDT, MOCSTATUS, MOCDATE, MOCTYPEALT_KEY, OLD_OVERDUESINCEDT, OLD_OVERDUE, ORG_TOTALPROV, INTREVERSEAMT, PS_BALANCE, NPS_BALANCE, DATECREATED, MODIFIEDBY, DATEMODIFIED, APPROVEDBY, DATEAPPROVED, CREATEDBY, PS_NPS_FLAG, UPGRADEDATE, OverduePrincipal, OverduePrincipalDt, Overdueinterest, OverdueIntDt, OverOtherdue, OverdueOtherDt, UnAppliedIntAmount, PrincipalBalance, SourceAssetClass, SourceNpaDate )
     ( 
       -----------------------FINACLE DATA-----------------------  
       SELECT ACBD.ACCOUNTENTITYID ACCOUNTENTITYID  ,
              1 ,--DA.AssetClassAlt_Key AS ASSETCLASSALT_KEY  

              ACC1.BalanceInActualAcCurrency BALANCEINCURRENCY  ,
              CASE 
                   WHEN NVL(ACC1.BalanceOutstandingINR, 0) <= 0 THEN 0
              ELSE NVL(ACC1.BalanceOutstandingINR, 0)
                 END BALANCE  ,
              ACC1.BalanceOutstandingINR SIGNBALANCE  ,
              CASE 
                   WHEN ACBD.ReferencePeriod IN ( 365,366,180,181 )
                    THEN NULL
              ELSE ACC1.LastCreditDate
                 END LASTCRDT  ,
              NVL(PrincipalOverdueAmt, 0) + NVL(InterestOverdueAmt, 0) + NVL(OthChargesOverdueAmt, 0) OVERDUE ,--TDUE  

              NULL TOTALPROV  ,
              --,NULL AS DIRECTBALANCE  
              --,NULL AS INDIRECTBALANCE  
              --,NULL AS LASTCRAMT  
              ACBD.REFCUSTOMERID REFCUSTOMERID  ,
              ACBD.SYSTEMACID REFSYSTEMACID  ,
              ACBD.AuthorisationStatus ,
              v_VEFFECTIVEFROM EFFECTIVEFROMTIMEKEY  ,
              49999 EFFECTIVETOTIMEKEY  ,
              --,CASE WHEN ACBD.SourceAlt_Key=6  AND ISNULl(dpd,0)>0 THEN DATEADD(DD,(ISNULl(dpd,0)*-1),@DATE)   
              CASE 
                   WHEN ACBD.SourceAlt_Key = 6
                     AND NVL(dpd, 0) > 0 THEN utils.dateadd('DD', ((NVL(dpd, 0) - 1) * -1), v_DATE -- aMAR - cHANGES ON 17032021 AS PER EMAIL BY ASHISH SIR DATED - 17-03-2021 1:59PM - SUBJECT - Credit Card NPA Computation  DATED    
                   )
              ELSE TO_DATE(MAIN_PRO.GETMINIMUMDATE(TO_CHAR(PrincipalOverDueSinceDt),TO_CHAR(InterestOverDueSinceDt),TO_CHAR(OthChangesOverDueSinceDt)),'YYYY-MM-DD')
                 END OVERDUESINCEDT ,--GET MINIMUM DATE FOR OVERDUE SINCE DATE  

              --,CASE WHEN DAYSDELQ >0  THEN CASE WHEN DIST1ND='NULL'  OR  DIST1ND='' THEN NULL ELSE CONVERT(Date, DIST1ND, 103) END END AS  OVERDUESINCEDT -- AS PER DICUSIION ON 12/06/2019  
              'N' MOCSTATUS  ,
              NULL MOCDATE  ,
              NULL MOCTYPEALT_KEY  ,
              NULL OLD_OVERDUESINCEDT  ,
              NULL OLD_OVERDUE  ,
              NULL ORG_TOTALPROV  ,
              NULL INTREVERSEAMT ,-- amar added  10062021  

              0 PS_BALANCE  ,
              0 NPS_BALANCE  ,
              SYSDATE DATECREATED  ,
              NULL MODIFIEDBY  ,
              NULL DATEMODIFIED  ,
              NULL APPROVEDBY  ,
              NULL DATEAPPROVED  ,
              'SSISUSER' CREATEDBY  ,
              NULL PS_NPS_FLAG  ,
              NULL UPGRADEDATE  ,
              NVL(ACC1.PrincipalOverdueAmt, 0) OverduePrincipal ,--overdue principal   

              PrincipalOverDueSinceDt OverduePrincipaldate ,--overdue principal date  

              NVL(ACC1.InterestOverdueAmt, 0) Overdueintereset ,--overdue intereset    

              ACC1.InterestOverDueSinceDt Overdueinteresetdate ,--overdue intereset    

              --  select *  
              acc1.OthChargesOverdueAmt ,
              acc1.OthChangesOverDueSinceDt ,
              acc1.UnAppliedInterestAmt ,
              acc1.POSBalance ,
              acc1.AssetClassCode SourceAssetClass  ,
              acc1.NPADate SourceNpaDate  
       FROM RBL_STGDB.ACCOUNT_ALL_SOURCE_SYSTEM ACC1
              JOIN RBL_TEMPDB.TempAdvAcBasicDetail ACBD   ON ACC1.CustomerAcID = ACBD.CustomerACID
              LEFT JOIN RBL_MISDB_PROD.DimAssetClassMapping DA   ON ACC1.AssetClassCode = DA.SrcSysClassCode
              AND ACBD.SourceAlt_Key = DA.SourceAlt_Key ----Added on 11-05-2022 as discussed with amar sir 

              AND DA.EffectiveFromTimeKey <= v_TimeKey
              AND DA.EffectiveToTimeKey >= v_TimeKey );


EXCEPTION WHEN NO_DATA_FOUND THEN DBMS_OUTPUT.PUT_LINE('NO DATA FOUND');
            WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "MAIN_PRO";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "RBL_STGDB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "MAIN_PRO";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "RBL_STGDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "RBL_TEMPDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_TEMP_RBL_TEMPDB"."ADVACBALANCEDETAIL_TEMP" TO "ADF_CDR_RBL_STGDB";
