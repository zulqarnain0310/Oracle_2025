--------------------------------------------------------
--  DDL for Procedure ACDAILYTXNDETAIL_MAIN_BKUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" 
-- =============================================
 -- Author:		<Author,,Name>
 -- Create date: <Create Date,,>
 -- Description:	<Description,,>
 -- =============================================

AS
   -- SET NOCOUNT ON added to prevent extra result sets from
   -- interfering with SELECT statements.
   v_vEffectiveto NUMBER(10,0);
   /*  New Customers Account Entity ID Update  */
   v_ENTITYKEY NUMBER(10,0) := 0;
-- Add the parameters for the stored procedure here

BEGIN

   SELECT Timekey - 1 

     INTO v_vEffectiveto
     FROM RBL_MISDB_PROD.Automate_Advances 
    WHERE  EXT_FLG = 'Y';
   SELECT MAX(ENTITYKEY)  

     INTO v_ENTITYKEY
     FROM RBL_MISDB_PROD.AcDailyTxnDetail ;
   IF v_ENTITYKEY IS NULL THEN

   BEGIN
      v_ENTITYKEY := 0 ;

   END;
   END IF;
   MERGE INTO RBL_TEMPDB.TempACDailyTXNDetail TEMP
   USING (SELECT TEMP.ROWID row_id, ACCT.ENTITYKEY
   FROM RBL_TEMPDB.TempACDailyTXNDetail TEMP
          JOIN ( SELECT "TEMPACDAILYTXNDETAIL".ROWID_ ,
                        (0 + ROW_NUMBER() OVER ( ORDER BY "TEMPACDAILYTXNDETAIL".ROWID_  )) ENTITYKEY  
                 FROM RBL_TEMPDB.TempACDailyTXNDetail 
                  WHERE  "TEMPACDAILYTXNDETAIL".ENTITYKEY = 0
                           OR "TEMPACDAILYTXNDETAIL".ENTITYKEY IS NULL ) ACCT --TEMP.CustomerAcID=ACCT.CustomerAcID
           ON TEMP.ROWID_ = ACCT.ROWID_ ) src
   ON ( TEMP.ROWID = src.row_id )
   WHEN MATCHED THEN UPDATE SET TEMP.ENTITYKEY = src.ENTITYKEY;
   INSERT INTO RBL_MISDB_PROD.AcDailyTxnDetail
     ( EntityKey, Branchcode, CustomerID, CustomerAcID, AccountEntityId, TxnDate, TxnType, TxnSubType, TxnTime, CurrencyAlt_Key, CurrencyConvRate, TxnAmount, TxnAmountInCurrency, ExtDate, TxnRefNo, TxnValueDate, MnemonicCode, Particular, AuthorisationStatus, CreatedBy, DateCreated, ModifiedBy, DateModified, ApprovedBy, DateApproved, Remark, TrueCredit, IsProcessed, Balance, D2Ktimestamp )
     ( SELECT EntityKey ,
              Branchcode ,
              CustomerID ,
              CustomerAcID ,
              AccountEntityId ,
              TxnDate ,
              TxnType ,
              TxnSubType ,
              TxnTime ,
              CurrencyAlt_Key ,
              CurrencyConvRate ,
              TxnAmount ,
              TxnAmountInCurrency ,
              ExtDate ,
              TxnRefNo ,
              TxnValueDate ,
              MnemonicCode ,
              Particular ,
              AuthorisationStatus ,
              CreatedBy ,
              DateCreated ,
              ModifiedBy ,
              DateModified ,
              ApprovedBy ,
              DateApproved ,
              Remark ,
              TrueCredit ,
              IsProcessed ,
              Balance ,
              SYSDATE D2Ktimestamp  
       FROM RBL_TEMPDB.TempACDailyTXNDetail A );--WHERE NOT EXISTS (SELECT * FROM DBO.AcDailyTxnDetail B
   --     WHERE A.CustomerAcID=B.CustomerAcID
   --     AND A.Branchcode=B.Branchcode
   --     AND A.TxnDate=B.TxnDate
   --     AND A.TxnType=B.TxnType
   --     AND A.TxnSubType=B.TxnSubType
   --     AND A.TxnRefNo=B.TxnRefNo
   --     )

EXCEPTION WHEN NO_DATA_FOUND THEN DBMS_OUTPUT.PUT_LINE('NO DATA FOUND');
            WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "MAIN_PRO";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "MAIN_PRO";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "RBL_MISDB_PROD";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "RBL_STGDB";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "RBL_STGDB";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "RBL_TEMPDB";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "ETL_MAIN_RBL_MISDB_PROD"."ACDAILYTXNDETAIL_MAIN_BKUP" TO "ADF_CDR_RBL_STGDB";
